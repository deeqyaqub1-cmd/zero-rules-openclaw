<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkillFence Pro ‚Äî Activated</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0b; --surface:#111113; --surface-2:#1a1a1e; --border:#2a2a2e;
    --text:#e8e8ec; --text-dim:#8888a0; --accent:#ff6b2b; --accent-glow:#ff6b2b33;
    --green:#22c55e; --green-dim:#22c55e22; --red:#ef4444;
    --mono:'JetBrains Mono',monospace; --sans:'DM Sans',system-ui,sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:var(--sans);line-height:1.6;min-height:100vh;display:flex;align-items:center;justify-content:center}
  body::before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:0}

  .container{max-width:560px;width:100%;padding:24px;position:relative;z-index:1}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:40px;text-align:center}
  .card.success{border-color:var(--green);box-shadow:0 0 40px var(--green-dim)}
  .card.loading{border-color:var(--border)}
  .card.error{border-color:var(--red);box-shadow:0 0 40px #ef444422}

  .icon{font-size:3rem;margin-bottom:16px}
  h1{font-family:var(--mono);font-size:1.4rem;font-weight:800;margin-bottom:8px;letter-spacing:-0.02em}
  .subtitle{color:var(--text-dim);font-size:0.95rem;margin-bottom:32px}

  .key-box{background:var(--bg);border:2px solid var(--green);border-radius:6px;padding:20px;margin-bottom:24px;position:relative;cursor:pointer;transition:all 0.2s}
  .key-box:hover{border-color:var(--accent);box-shadow:0 0 20px var(--accent-glow)}
  .key-label{font-family:var(--mono);font-size:0.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px}
  .key-value{font-family:var(--mono);font-size:1.3rem;font-weight:800;color:var(--green);word-break:break-all;letter-spacing:0.02em}
  .key-copy{font-family:var(--mono);font-size:0.7rem;color:var(--text-dim);margin-top:8px;transition:color 0.2s}

  .steps{text-align:left;background:var(--surface-2);border-radius:6px;padding:20px 24px;margin-bottom:24px}
  .steps h3{font-family:var(--mono);font-size:0.8rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px}
  .step{display:flex;gap:12px;margin-bottom:12px;font-size:0.85rem}
  .step:last-child{margin-bottom:0}
  .step-num{font-family:var(--mono);font-weight:800;color:var(--accent);min-width:20px}
  .step-text{color:var(--text-dim)}
  .step-text code{font-family:var(--mono);background:var(--bg);padding:2px 8px;border-radius:3px;font-size:0.8rem;color:var(--text);border:1px solid var(--border)}

  .cmd-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:12px 16px;font-family:var(--mono);font-size:0.85rem;text-align:left;margin:8px 0;cursor:pointer;transition:border-color 0.2s;word-break:break-all}
  .cmd-box:hover{border-color:var(--accent)}
  .cmd-box .prompt{color:var(--accent)}

  .btn-back{display:inline-block;font-family:var(--mono);font-size:0.85rem;color:var(--text-dim);text-decoration:none;padding:10px 20px;border:1px solid var(--border);border-radius:4px;transition:all 0.2s;margin-top:8px}
  .btn-back:hover{border-color:var(--text-dim);color:var(--text)}

  .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .error-msg{color:var(--red);font-family:var(--mono);font-size:0.85rem;margin-bottom:16px}

  .save-warning{font-family:var(--mono);font-size:0.7rem;color:var(--accent);background:var(--accent-glow);border:1px solid #ff6b2b44;border-radius:4px;padding:8px 12px;margin-bottom:20px}
</style>
</head>
<body>
<div class="container">

  <!-- Loading State -->
  <div class="card loading" id="state-loading">
    <div class="spinner"></div>
    <h1>Verifying payment...</h1>
    <p class="subtitle">Hang tight ‚Äî confirming with Stripe.</p>
  </div>

  <!-- Success State -->
  <div class="card success" id="state-success" style="display:none">
    <div class="icon">üõ°Ô∏è</div>
    <h1>Welcome to SkillFence Pro</h1>
    <p class="subtitle">Your license key is ready. Save it ‚Äî you'll need it on every machine.</p>

    <div class="save-warning">‚ö† Save this key now. Bookmark this page as backup.</div>

    <div class="key-box" id="key-box" onclick="copyKey()">
      <div class="key-label">Your License Key</div>
      <div class="key-value" id="license-key">‚Äî</div>
      <div class="key-copy" id="key-copy-text">Click to copy</div>
    </div>

    <div class="steps">
      <h3>Activate in 10 seconds</h3>
      <div class="step">
        <span class="step-num">1</span>
        <span class="step-text">Copy your key above</span>
      </div>
      <div class="step">
        <span class="step-num">2</span>
        <span class="step-text">Open your terminal and run:</span>
      </div>
    </div>

    <div class="cmd-box" id="activate-cmd" onclick="copyCmd()">
      <span class="prompt">$</span> node monitor.js --activate <span id="cmd-key">YOUR-KEY</span>
    </div>
    <div style="font-family:var(--mono);font-size:0.65rem;color:var(--text-dim);margin-bottom:20px;text-align:left" id="cmd-copy-text">Click to copy full command</div>

    <div class="steps" style="margin-bottom:24px">
      <div class="step">
        <span class="step-num">3</span>
        <span class="step-text">Done! Run <code>--dashboard</code> to see your Pro dashboard with real data.</span>
      </div>
    </div>

    <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px">Use this same key on any machine. Just run <code style="font-family:var(--mono);background:var(--bg);padding:1px 6px;border-radius:3px;font-size:0.75rem;border:1px solid var(--border)">--activate</code> again.</p>

    <a href="/skillfence/" class="btn-back">‚Üê Back to SkillFence</a>
  </div>

  <!-- Error State -->
  <div class="card error" id="state-error" style="display:none">
    <div class="icon">‚ö†Ô∏è</div>
    <h1>Something went wrong</h1>
    <p class="error-msg" id="error-msg">Could not verify payment.</p>
    <p class="subtitle">If you were charged, contact <a href="mailto:hello@cascadeai.dev" style="color:var(--accent)">hello@cascadeai.dev</a> with your receipt and we'll get you sorted immediately.</p>
    <a href="/skillfence/" class="btn-back">‚Üê Back to SkillFence</a>
  </div>

</div>

<script>
  var licenseKey = '';

  function copyKey() {
    if (!licenseKey) return;
    navigator.clipboard.writeText(licenseKey);
    var el = document.getElementById('key-copy-text');
    el.textContent = '‚úì Copied!';
    el.style.color = '#22c55e';
    setTimeout(function() { el.textContent = 'Click to copy'; el.style.color = ''; }, 2000);
  }

  function copyCmd() {
    if (!licenseKey) return;
    navigator.clipboard.writeText('node monitor.js --activate ' + licenseKey);
    var el = document.getElementById('cmd-copy-text');
    el.textContent = '‚úì Copied!';
    el.style.color = '#22c55e';
    setTimeout(function() { el.textContent = 'Click to copy full command'; el.style.color = ''; }, 2000);
  }

  function showState(state) {
    document.getElementById('state-loading').style.display = state === 'loading' ? '' : 'none';
    document.getElementById('state-success').style.display = state === 'success' ? '' : 'none';
    document.getElementById('state-error').style.display = state === 'error' ? '' : 'none';
  }

  async function verifyPayment() {
    var params = new URLSearchParams(window.location.search);
    var sessionId = params.get('session_id');

    if (!sessionId) {
      document.getElementById('error-msg').textContent = 'No payment session found. Please complete checkout first.';
      showState('error');
      return;
    }

    try {
      var resp = await fetch('/api/skillfence-license?session_id=' + encodeURIComponent(sessionId));
      var data = await resp.json();

      if (data.success && data.license_key) {
        licenseKey = data.license_key;
        document.getElementById('license-key').textContent = licenseKey;
        document.getElementById('cmd-key').textContent = licenseKey;
        showState('success');
      } else {
        document.getElementById('error-msg').textContent = data.error || 'Payment verification failed.';
        showState('error');
      }
    } catch (err) {
      document.getElementById('error-msg').textContent = 'Network error ‚Äî could not reach server. Try refreshing.';
      showState('error');
    }
  }

  verifyPayment();
</script>
</body>
</html>
